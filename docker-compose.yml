services:
  # The "Brain" - Laravel App & Filament UI
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: site-sync
    container_name: sitesync_app
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./:/var/www
      - ~/.ssh:/root/.ssh:ro # Mount your local SSH keys (read-only) to access remotes
    networks:
      - sitesync_network

  # The "Muscle" - Handles the heavy lifting (rsync, wp-cli, mysqldump)
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sitesync_worker
    restart: unless-stopped
    command: php artisan queue:work --timeout=3600
    volumes:
      - ./:/var/www
      - ~/.ssh:/root/.ssh:ro
    networks:
      - sitesync_network
    depends_on:
      - app
      - db

  # The Web Server
  nginx:
    image: nginx:alpine
    container_name: sitesync_nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./:/var/www
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
    networks:
      - sitesync_network

  # The Database (For storing site configs and sync logs)
  db:
    image: mariadb:10.11
    container_name: sitesync_db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: sitesync_ui
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - sitesync_db_data:/var/lib/mysql
    networks:
      - sitesync_network

  # Redis for Queue Management
  redis:
    image: redis:alpine
    container_name: sitesync_redis
    networks:
      - sitesync_network

networks:
  sitesync_network:
    driver: bridge

volumes:
  sitesync_db_data: